<!--
  [LICENSE]
  Taskboard
  ---
  Copyright (C) 2015 - 2016 Objective Solutions
  ---
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="widget-cfd">

    <template>

        <style>
        </style>

        <widget-wrap title="CFD" is-ready="{{isReady}}" chart="{{chart}}" error-message="{{errorMessage}}">

            <div id="cfd" class="tb-chart"></div>

        </widget-wrap>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'widget-cfd',

                properties: {
                    selectedProjectKey: {
                        type: String,
                        notify: true
                    },
                    selectedDate: {
                        type: String,
                        notify: true,
                        value: '',
                    },
                    isReady: {
                        type: Boolean,
                        notify: true,
                        value: false
                    },
                    errorMessage: {
                        type: String,
                        notify: true,
                        value: ''
                    },
                    chart: {
                        type: Object,
                        readOnly: true,
                        notify: true,
                        value: function() { return {}; }
                    }
                },

                observers: [
                    '_onProjectSelected(selectedProjectKey, selectedDate)',
                ],

                ready: function() {
                    this.dateFormat = d3.time.format('%Y-%m-%d');
                },

                _onProjectSelected: function(selectedProjectKey, selectedDate) {
                    this.loadCfdChart(selectedProjectKey);
                },

                loadCfdChart: function(project) {
                    this.reset();

                    var self = this;
                    d3.json("/api/projects/"+ project + "/followup/cfd", function(error, cfdData) {
                        if(self.handleErrors(error, cfdData))
                            return;

                        self.setCfdData(cfdData);

                        if(!self.isChartInitialized())
                            self.createChart();

                        self.updateChart();
                        self.isReady = true;
                    });
                },

                reset: function() {
                    this.isReady = false;
                    this.set('errorMessage', '');
                },

                handleErrors(error, cfdData) {
                    if(error) {
                        this.errorMessage = error.message;
                        return true;
                    }
                    if(!cfdData.data.length) {
                        this.set('errorMessage', 'Impossible to generate CFD. No data for this project.');
                        return true;
                    }

                    return false;
                },

                setCfdData: function(cfdData) {
                    // convert dates
                    for(var i = 0; i < cfdData.dates.length; ++i) {
                        cfdData.dates[i] = this.dateFormat.parse(cfdData.dates[i]);
                    }

                    this.cfdData = cfdData;

                    this.ndx = crossfilter(this.cfdData.data);
                    this.cfdDim = this.ndx.dimension(function(d) {
                        return [d.label, d.index];
                    });
                    this.cfdGroup = this.cfdDim.group()
                        .reduceSum(function(d) {
                            return d.count;
                        });
                },

                isChartInitialized: function() {
                    return !_.isEmpty(this.chart) ? true : false;
                },

                createChart: function() {
                    var self = this;

                    this._setChart(dc.seriesChart("#cfd"));

                    var LABEL_INDEX = 0;
                    var DATE_INDEX = 1;

                    // basic chart configuration
                    this.chart
                        .margins({top: 0, right: 0, bottom: 15, left: 200})
                        .legend(dc.legend()
                            .gap(8)
                        )

                    // mouse interactions
                    this.chart
                        .brushOn(false)       // don't select with drag-n-drop
                        .mouseZoomable(true)  // zoom with mouse wheel
                        .title(function (d){  // popup text on mouse over data points
                            return self.cfdData.labels[d.key[LABEL_INDEX]] + ": " + d.value + " (" + self.dateFormat(self.cfdData.dates[d.key[DATE_INDEX]]) + ")";
                        });

                    // chart data definition
                    this.chart
                        .chart(function(c) {
                            return dc.lineChart(c)
                                .renderArea(true)
                                .renderDataPoints(true);
                        })
                        .seriesAccessor(function(d) {
                            return (d.key[LABEL_INDEX] + 1) + ": " + self.cfdData.labels[d.key[LABEL_INDEX]];
                        })
                        .keyAccessor(function(d) {
                            return d.key[DATE_INDEX];
                        })
                        .valueAccessor(function(d) {
                            return d.value;
                        });

                    this.chart.on('preRender', function() {
                        self.chart
                            .xAxis()
                                .ticks(Math.max(self.chart.width()/100, 2))

                    });
                },

                updateChart: function() {
                    var self = this;
                    var topPadding = 10;
                    var xScale = d3.scale.linear()
                            .domain([0, this.cfdData.dates.length - 1]);
                    var yScale = d3.scale.linear()
                            .domain([0, this.cfdGroup.top(1)[0].value + topPadding]);

                    var dateScale = d3.time.scale()
                            .domain([this.cfdData.dates[0], this.cfdData.dates[this.cfdData.dates.length - 1]])
                            .range([0, this.cfdData.dates.length - 1]);

                    this.chart
                        .dimension(this.cfdDim)
                        .group(this.cfdGroup)
                        .x(xScale)
                        .y(yScale)
                        .xAxis()
                            .tickFormat(function(v) {
                                return self.dateFormat(dateScale.invert(v));
                            });

                    this.chart.render();
                }
            });
        })();
    </script>
</dom-module>