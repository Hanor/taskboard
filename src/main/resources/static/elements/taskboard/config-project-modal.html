<dom-module id="config-project-modal">

    <template>

        <style>
            .error-message {
                color: red;
                font-weight: bold;
                margin-top: 5px;
                margin-bottom: 15px;
            }

            .configuration-form {
                width: 400px;
                padding: 15px;
            }

            .input-wrapper {
                margin-top: 20px;
            }

            .project-status {
                transition: all .3s ease;
            }

            .project-status.project-status--active {
                color: #3f51b5;
            }

            .project-status.project-status--archived {
                opacity: .6;
            }

            paper-button[disabled].colorful {
                opacity: .6;
            }
        </style>

        <iron-signals
                on-iron-signal-open-project-configuration-modal="openByEvent"
        ></iron-signals>

        <alert-modal id="alertModalConfiguration"></alert-modal>
        <wrap-modal id="modal" title="Project Configuration for [[projectConfiguration.projectKey]]">
            <div class="modal-content">

                <form class="configuration-form">
                    <div class="error-message" hidden$="{{!errorMessage}}">{{errorMessage}}</div>
                    <paper-input id="projectStartDate" always-float-label
                                 label="Project Start Date ([[dateFormatPlaceholder]])"
                                 value="{{projectConfiguration.startDate}}"
                                 tabindex="1"
                                 maxlength="10"
                                 pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}"></paper-input>

                    <paper-input id="projectDeliveryDate" always-float-label
                                 label="Project End Date ([[dateFormatPlaceholder]])"
                                 value="{{projectConfiguration.deliveryDate}}"
                                 maxlength="10"
                                 pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}"></paper-input>

                    <div class="input-wrapper">
                        <paper-toggle-button class="tb-toggle-button" checked="{{!projectConfiguration.isArchived}}"
                                             on-change="_onChangeArchived">
                            Project status:
                            <span class$="project-status project-status--[[_getArchivedText(projectConfiguration.isArchived)]]">
                                [[_getArchivedText(projectConfiguration.isArchived, 'true')]]
                            </span>
                        </paper-toggle-button>
                    </div>

                </form>
            </div>
            <div class="modal-footer">
                <paper-spinner active hidden$="[[!showLoadingSpinner]]">...</paper-spinner>
                <paper-button id="updateProjectConfiguration" raised class="colorful" title="Update Configuration"
                              disabled="[[showLoadingSpinner]]"
                              on-tap="updateConfiguration">
                    Update
                </paper-button>
            </div>
        </wrap-modal>

    </template>
    <script src="/static/bower_components/moment/min/moment-with-locales.js"></script>
    <script src="/static/bower_components/jquery.maskedinput/dist/jquery.maskedinput.min.js"></script>
    <script>
        (function () {
            Polymer({
                is: 'config-project-modal',

                properties: {
                    projectConfiguration: {
                        type: Object
                    },
                    showLoadingSpinner: {
                        type: Boolean
                    },
                    dateFormatPlaceholder: {
                        type: String
                    }
                },

                open: function(projectConfiguration) {
                    moment.locale(taskboard.getLocaleFromBrowser());
                    this.set('dateFormatPlaceholder', moment.localeData().longDateFormat("L").toLowerCase());
                    this.set('errorMessage', '');
                    this._setProjectFilterConfiguration(projectConfiguration);
                    this.showLoading(false);
                    this.$.projectStartDate.invalid = false;
                    this.$.projectDeliveryDate.invalid = false;

                    this.$.modal.open();
                    this.$.projectStartDate.$.input.focus();

                    // after set this mask, polymer binding will not work properly
                    $(this.$.projectStartDate.$.input).mask("99/99/9999", {placeholder:" "});
                    $(this.$.projectDeliveryDate.$.input).mask("99/99/9999", {placeholder:" "});
                },

                _setProjectFilterConfiguration: function(projectFilterConfiguration) {
                    var newProjFilterConf = clone(projectFilterConfiguration);
                    newProjFilterConf.startDate = this._getLocaleDate(newProjFilterConf.startDate);
                    newProjFilterConf.deliveryDate = this._getLocaleDate(newProjFilterConf.deliveryDate);
                    this.set('projectConfiguration', {});
                    this.set('projectConfiguration', newProjFilterConf);
                },

                openByEvent: function(projectConfigurationEvent) {
                    this.open(projectConfigurationEvent.detail);
                },

                updateConfiguration: function() {
                    var self = this;

                    var projectKey = self.projectConfiguration.projectKey;

                    if (!self._isValid())
                        return;

                    self.showLoading(true);

                    // get directly from component because the polymer binding is not working after set the mask on input
                    var data = {
                        projectKey: self.projectConfiguration.projectKey,
                        startDate: self._getISODate(self.$.projectStartDate.$.input.value),
                        deliveryDate: self._getISODate(self.$.projectDeliveryDate.$.input.value),
                        isArchived: self.projectConfiguration.isArchived
                    };

                    $.ajax({
                        data: JSON.stringify(data),
                        type: 'POST',
                        contentType: "application/json; charset=utf-8",
                        url: '/api/projects/' + projectKey + '/configuration'
                    }).done(function () {
                        self.showLoading(false);
                        self.$.modal.close();
                        self.$.alertModalConfiguration.open(
                            "Configuration Updated",
                            "Configuration for project " + projectKey + " has been updated. We will reload the page to apply the configuration.",
                            function() { location.reload(); }
                        );
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        console.error(errorThrown);
                        self.showError(jqXHR, self);
                    });
                },

                showLoading: function(show) {
                    this.showLoadingSpinner = show;
                },

                showError: function(jqXHR, self) {
                    self.showLoading(false);
                    if  (jqXHR && jqXHR.responseText) {
                        var responseError = JSON.parse(jqXHR.responseText);
                        self.errorMessage = responseError.message;
                        $(".error-message").show().delay(3000).fadeOut();
                    } else {
                        self.errorMessage = "The request has failed";
                        $(".error-message").show().delay(3000).fadeOut();
                    }
                },

                _isValid: function() {
                    return this.$.projectStartDate.validate() & this.$.projectDeliveryDate.validate();
                },

                _getLocaleDate: function(date) {
                    if (date)
                        return moment(date).format("L");
                },

                _getISODate: function(date) {
                    if(date)
                        return moment(date, "L").format("YYYY-MM-DD");
                },

                _getArchivedText: function(isArchived, capitalize) {
                    var archivedText = taskboard.getArchivedText(isArchived);
                    return (String(capitalize).toLowerCase() === 'true') ? getCapitalized(archivedText) : archivedText;
                },

                _onChangeArchived: function(e) {
                    this.set('projectConfiguration.isArchived', !e.target.active);
                }

            });
        })();
    </script>
</dom-module>