<!--
  [LICENSE]
  Taskboard
  ---
  Copyright (C) 2015 - 2016 Objective Solutions
  ---
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="board-search">

    <template>

        <style>
            :host {
                display: flex;
                align-items: center;
            }

            .input-search {
                border-radius: 3px;
                height: 30px;
                width: 200px;
                padding: 0 10px;
                border: none;
                background: #DDD;
            }

            paper-dropdown-menu.custom {
                width: 150px;
                margin-left: 10px;
                --paper-input-container-underline: { display: none; };
                --paper-input-container-label: { font-size: 14px; };
                --paper-input-container-input: { font-size: 14px; };
            }

            paper-listbox {
                border-radius: 3px;
            }

            paper-dropdown-menu.no-versions {
                width: 230px;
                color: gray;
            }

            /*
                Versions dropdown
            */
            .versions-dropdown paper-input-container {
                background: #DDD !important;
                padding: 0 !important;
                border-radius: 3px !important;
                height: 30px !important;
            }

            .versions-dropdown .input-content {
                height: 30px !important;
            }

            .versions-dropdown label, .versions-dropdown input {
                color: inherit !important;
                padding: 0 0 0 10px !important;
            }

            .versions-dropdown iron-dropdown {
                top: 35px !important;
            }

            .versions-dropdown .underline {
                display: none;
            }

            .versions-dropdown paper-listbox {
                padding: 10px 0;
            }

            .versions-dropdown paper-item {
                font-size: 15px;
                padding: 0 10px;
                height: 14px;
                line-height: 22px;
                min-height: 22px;
                display: block;
            }
        </style>

        <iron-signals on-iron-signal-search-filter-reset="searchReset"
                      on-iron-signal-refresh-release-filter="retrieveVersions"></iron-signals>

        <input id="searchIssues" class="input-search" value="{{query::input}}" type="search"
               placeholder="Search Issues" results="5" autocomplete="off"/>
        <template is="dom-if" if="{{isVersionConfigured()}}">
            <paper-dropdown-menu class$="versions-dropdown custom {{getClassNoVersions(versions)}}" id="searchVersion"
                                 label="{{getLabelSearchVersion(versions)}}" no-label-float
                                 on-value-changed="searchIssue" on-keydown="searchVersionOnKeyDown">
                <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{versionSelected}}">
                    <template is="dom-repeat" items="{{versions}}" as="itemVersion">
                        <paper-item value="{{itemVersion.id}}">{{getVersionString(itemVersion)}}</paper-item>
                    </template>
                </paper-listbox>
            </paper-dropdown-menu>
            <div class="clear-button">
                <paper-icon-button id="clearVersionButton" icon="clear" on-click="clearVersion" hidden></paper-icon-button>
            </div>
        </template>

    </template>

    <script>
        (function () {
            Polymer({
                is: 'board-search',

                properties: {
                    query: {
                        type: String,
                        notify: true
                    },
                    versionSelected: {
                        type: String,
                        notify: true
                    },
                    versions: {
                        type: Array,
                        notify: true
                    }
                },

                ready: function() {
                    this.retrieveVersions();
                },

                listeners: {
                    'searchIssues.change': 'searchIssue',
                    'query-changed': 'searchIssue'
                },

                searchIssue: function () {
                    if (this.isVersionConfigured())
                        clearVersionButton.hidden = this.versionSelected ? false : true;

                    this.fire('iron-signal', {name: 'search-filter-changed',
                                              data: { query: this.query , version: this.versionSelected }});
                },

                searchReset: function() {
                    this.query = "";
                    this.clearVersion();
                },

                isVersionConfigured: function() {
                    return CUSTOMFIELD.RELEASE;
                },

                retrieveVersions: function() {
                    var previousSelected = this.versionSelected;
                    this.clearVersion();
                    var listVersions = [];
                    taskboard.getAspectFilters().forEach(function(itemFilter) {
                        if (itemFilter.description !== 'Project')
                            return;

                        itemFilter.aspectsSubitemFilter.forEach(function(subitemFilter) {
                            if (!subitemFilter.visible || !subitemFilter.selected ||
                                subitemFilter.versions == null)
                                return;

                            subitemFilter.versions.forEach(function(v) {
                                listVersions.push({ id: v.id, project: this.value, name: v.name })
                            }, subitemFilter);
                        });
                    });

                    if (listVersions.length > 0)
                        listVersions = [null].concat(listVersions);

                    this.versions = listVersions;
                    if (previousSelected) {
                        var newVersion = _.find(listVersions, function(v) { return v && v.id == previousSelected; });
                        if(newVersion) {
                            this.versionSelected = previousSelected;
                            var paperDropdownMenu = this.$$('#searchVersion');
                            this.async(function() {
                                // workaround to force label update
                                paperDropdownMenu._selectedItemChanged(paperDropdownMenu.selectedItem);
                            });
                        }
                    }
                },

                getVersionString: function(version) {
                    if (!version)
                        return "";

                    return version.project + " - " + version.name;
                },

                clearVersion: function() {
                    this.versionSelected = "";
                },

                searchVersionOnKeyDown: function(e) {
                    if (e.key === 'Escape')
                        this.clearVersion();
                },

                getLabelSearchVersion: function(versions) {
                    if (this.hasVersions(versions))
                        return 'Release';
                    return 'No releases for visible projects';
                },

                getClassNoVersions: function(versions) {
                    if (this.hasVersions(versions))
                        return '';
                    return 'no-versions';
                },

                hasVersions: function(versions) {
                    return versions && versions.length > 0;
                }
            });
        })();
    </script>

</dom-module>
