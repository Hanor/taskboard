<!--
  [LICENSE]
  Taskboard
  - - -
  Copyright (C) 2015 - 2016 Objective Solutions
  - - -
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="issue-detail">

    <template>

        <style>
            :host {
            }

            .card-custom {
                background: transparent;
                width: 100%;
                min-height: 360px;
                padding: 20px;
                margin: 0;
            }

            .half-column {
            }

            .card-header-custom {
                width: 100%;
                margin-bottom: 30px;
                font-size: 24px;
                display: flex;
            }

            .card-header-info {
                flex: 1;
            }

            .card-header-breadcrumb {
                margin-bottom: 10px;
                font-size: 15px;
            }

            .arrow {
                margin: 0 5px;
            }

            paper-button.headerLink {
                min-width: initial;
                margin: 0px;
                padding: 0px;
                font-weight: normal;
            }

            .issue-key-link {
                font-weight: 600;
            }

            .card-header-title paper-button {
                text-transform: none;
                font-size: 25px;
                line-height: normal;
                display: block;
            }

            .sub-header {
                line-height: normal;
                margin-bottom: 5px;
                font-size: 13px;
                font-weight: 600;
            }

            .content-row {
                display: flex;
                margin-top: 20px;
                margin-left: -10px;
                margin-right: -10px;
            }

            .content-row:first-child {
                margin-top: 0;
            }

            .column-block {
                flex: 1;
                margin-left: 10px;
                margin-right: 10px;
            }

            .column-block.top-bottom-alignment {
                display: flex;
                flex-direction: column;
            }

            .column-block.top-bottom-alignment .sub-content {
                margin-top: auto;
            }

            .sub-content {
                font-size: 15px;
            }

            paper-button {
                margin-bottom: 12px;
            }

            .card-header-buttons {
                padding: 0;
                margin-left: auto;
            }

            .icon-text {
                display: flex;
                align-items: center;
            }

            .icon-text .icon {
                margin-right: 5px;
                filter: initial;
                bottom: initial;
            }

            .assign-icon {
                height: 17px;
                width: 18px;
            }

            paper-material, paper-button {
                box-shadow: none !important;
            }

            paper-button.colorful {
                color: #4285f4;
            }

            paper-button[disabled].colorful {
                opacity: .6;
            }

            paper-button[raised].colorful {
                background: #4285f4;
                color: #fff;
            }

            paper-button[toggles] {
                transition: all 0.3s;
            }

            paper-button[toggles][active] {
                background-color: rgba(0, 0, 0, 0.25);
            }

            paper-button[toggles][active].colorful {
                background-color: rgba(66, 133, 244, 0.25);
            }

            paper-button[toggles][active][raised].colorful {
                background-color: rgba(66, 133, 244, 0.75);
            }

            paper-button.parentLink {
                font-size: 15px;
                font-weight: 600;
                margin: 0px;
                padding: 0px;
                text-align: left;
                color: #3B50C7;
            }

            paper-button.subtaskLink {
                font-size: inherit;
                font-weight: 600;
                color: #3B50C7;
                margin: 0 5px 0 0;
                padding: 0;
                display: inline;
            }

            paper-material.subtaskPanel {
                margin-top: 5px;
            }

            paper-material.subtaskPanel:first-child {
                margin-top: 0;
            }

            paper-material.highlightPanel {
                padding: 4px;
                padding-left: 8px;
                padding-right: 8px;
                border-radius: 5px;
                color: white;
                background-color: #7180D6;
                margin: 2px;
            }

            .red {
                --paper-progress-active-color: var(--paper-red-500);
                --paper-progress-secondary-color: var(--paper-red-100);
            }

            .green {
                --paper-progress-active-color: var(--paper-light-green-500);
                --paper-progress-secondary-color: var(--paper-light-green-100);
            }

            .content-box {
            }

            #timetracking_content {
                height: 40px;
            }

            #timetracking_content paper-progress {
                width: 100%;
                --paper-progress-height: 10px;
                margin-top: 5px;
            }

            #modal {
                background: transparent;
                min-width: 600px;
                min-height: 360px;
                margin: 0;
                display: block;
                font-family: inherit;
            }

            #loadCard {
                margin-top: 12px;
            }

            .bottom {
                margin: 4px;
                display: flex;
            }

            .icon-blocked {
                color: #F78181;
                bottom: 3px;
                -webkit-filter: drop-shadow(1px 1px 1px #616161);
                filter: drop-shadow(1px 1px 1px #616161);
            }

            .icon-cancelada {
                color: #FFCD00;
                bottom: 3px;
                -webkit-filter: drop-shadow(1px 1px 1px #616161);
                filter: drop-shadow(1px 1px 1px #616161);
            }

            .info {
                -webkit-filter: drop-shadow(1px 1px 1px #616161);
                filter: drop-shadow(1px 1px 1px #616161);
            }

            .buttonClose {
                min-width: auto;
                display: inline;
                padding: 0;
                margin: 0;
            }

            textarea {
                height: 30px;
                width: 100%;
                border: none;
                background-color: inherit;
                margin-top: 7px;
            }

            .icon img {
                display: block;
            }

            .icon-small {
                width: 25px;
                height: 25px;
            }

            .scroll {
                padding: 10px;
                overflow: auto;
                overflow-x: hidden;
                max-height: 150px;
                max-width: 100%;
                background-color: white;
            }

            .custom-footer {
                margin-top: 20px;
            }

            .custom-footer-buttons {
                display: flex;
                margin-left: -5px;
                margin-right: -5px;
            }

            .custom-footer-buttons paper-button {
                padding: 5px 10px;
                margin: 0 5px;
                text-transform: none;
                text-align: center;
            }

            paper-spinner[aria-hidden=true] {
                display: none;
            }

            .last-block-reason-textarea {
                border: 1px solid #CCC;
                background: #FFF;
                width: 100%;
                min-height: 54px;
                min-width: 100%;
                max-width: 100%;
                padding: 5px;
                margin: 0px;
                font-size: inherit;
                line-height: normal;
                font-family: inherit;
                color: inherit;
            }

            .last-block-reason-textarea:disabled {
                background: #DDD;
                color: #555;
            }

            .glasspane {
                position: absolute;
                left: 0px;
                width: 100%;
                height: 100%;
                background-color: rgba(197, 202, 233, 0.72);
                z-index: 1000;
                visibility: hidden;
                margin: 0;
                padding: 0;
                cursor: pointer;
            }

            .glasspane span {
                font-size: 24px;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 100%;
                text-align: center;
                line-height: 30px;
            }

            .visible-glasspane {
                visibility: visible !important;
            }

            .message-box {
                display: flex;
                align-items: center;
                padding: 10px;
                margin-top: 20px;
            }

            .message-box--error {
                background: #F4A9A1;
            }

            .message-box--updating {
                background: #fdf8b2;
            }

            .message-box__icon {
                flex: 0 0 auto;
                width: 24px;
                height: 24px;
                padding: 0;
                margin: 0 10px 0 0;
            }

            .message-box__message {
                flex: 1;
                margin: 0;
                font-weight: bold;
            }

            .message-box__close {
                flex: 0 0 auto;
                width: 16px;
                height: 16px;
                padding: 0;
                margin: 0 0 0 10px;
            }

        </style>

        <iron-ajax id="ajaxTransitions"
                   method="POST"
                   url="/ws/issues/transitions"
                   body="{{item.issueKey}}"
                   content-type='application/json'
                   headers='{"Content-Type": "application/json"}'
                   last-response="{{transitions}}"></iron-ajax>
        <iron-ajax id="ajaxTimetracking"
                   method="POST"
                   url="/ws/issues/timetracking"
                   body="{{item}}"
                   content-type='application/json'
                   headers='{"Content-Type": "application/json"}'
                   last-response="{{timetracking}}"
                   on-response="timetrackingCallback"
                   on-error="hideTimetracking"></iron-ajax>

        <iron-signals on-iron-signal-issues-updated="updateIssue"></iron-signals>
        <paper-dialog id="modal" with-backdrop modal
                      entry-animation="scale-up-animation" exit-animation="fade-out-animation"
                      on-iron-overlay-closed="_afterClose">

                <div class$="glasspane {{issueChangeStateClass}}" on-tap="refreshIfUpdated">
                    <span>This issue has been updated. <br>Click to refresh its contents.</span>
                </div>

            <paper-card class="card-custom">

                <div class="card-header-custom">
                    <div class="card-header-info">
                        <div class="card-header-breadcrumb">
                            <span class="project-title">
                                {{item.project}}
                            </span>
                            <template is="dom-if" if="{{item.parent}}">
                                <span class="parent-key">
                                    <span class="arrow">></span>
                                    <paper-button class="parentLink" on-tap="openJira" data-issue-key$="{{item.parent}}">{{item.parent}}</paper-button>
                                </span>
                            </template>
                            <span class="issue-key">
                                <span class="arrow">></span>
                                <paper-button class="headerLink issue-key-link" on-tap="openJira" data-issue-key$="{{item.issueKey}}">{{item.issueKey}}</paper-button>
                            </span>
                        </div>
                        <div class="card-header-title">
                            <paper-button class="headerLink" on-tap="openJira" data-issue-key$="{{item.issueKey}}">{{item.summary}}</paper-button>
                        </div>
                    </div>
                    <div class="card-header-buttons">
                        <paper-button class="buttonClose" on-tap="close">
                            <iron-icon icon="clear"></iron-icon>
                        </paper-button>
                    </div>
                </div>

                <div class="content-box">
                    <div class="content-row">

                        <div class="column-block issue-type">
                            <div class="sub-header">Issue type</div>
                            <div class="icon-text">
                                <div class="icon">
                                    <img id="issueTypeIcon" class="icon-small"
                                         title$="{{getIssueTypeName(item.type)}}" src$="{{getIssueTypeImage(item)}}"/>
                                </div>
                                <div class="text">
                                    {{getIssueTypeName(item.type)}}
                                </div>
                            </div>
                        </div>

                        <template is="dom-if" if="{{issueBlocked(item)}}">
                            <div class="column-block item-icon-text blocked">
                                <div class="sub-header">Blocked</div>
                                <div class="icon-text">
                                    <iron-icon class="icon icon-blocked icon-small" icon="icons:block"></iron-icon>
                                    <div class="text">
                                        Blocked
                                    </div>
                                </div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{issueCancelada(item)}}">
                            <div class="column-block item-icon-text-canceled">
                                <div class="sub-header">Canceled</div>
                                <div class="icon-text">
                                    <iron-icon class="icon icon-cancelada icon-small" icon="warning"></iron-icon>
                                    <div class="text">
                                        Canceled
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div class="column-block">
                            <div class="sub-header">Status</div>
                            <div class="sub-content horizontal layout">
                                <paper-material class="highlightPanel">{{getStatusName(item.status)}}</paper-material>
                            </div>
                        </div>

                        <div class="column-block half-column">
                            <div class="sub-header">Class of Service</div>
                            <div id="classOfServiceValue" class="sub-content">
                                {{item.classOfServiceValue}}
                            </div>
                        </div>

                    </div>

                    <div class="content-row">

                        <div class="column-block half-column">
                            <div class="sub-header">Assignees</div>
                            <div class="sub-content flex horizontal layout wrap">
                                <template is="dom-repeat" items="{{getAssignees(item)}}" as="assignee">
                                    <paper-material class="assignee highlightPanel">
                                        <span>{{assignee}}</span>
                                        <template is="dom-if" if="{{isInvalidTeam(item)}}">
                                            <iron-icon class="icon icon-cancelada icon-small" icon="warning" title="{{getTitleIconInvalidTeam(item)}}"></iron-icon>
                                        </template>
                                    </paper-material>
                                </template>
                            </div>
                        </div>

                    </div>

                    <div class="content-row">
                        <div class="column-block">
                            <div class="sub-header">Description</div>
                            <marked-element class="scroll" markdown="{{getDescription(item)}}"></marked-element>
                        </div>
                    </div>

                    <template is="dom-if" if="{{item.customfields.sizes.length}}">
                        <div class="content-row">

                            <template is="dom-repeat" items="{{item.customfields.sizes}}" as="size">
                                <div class="column-block top-bottom-alignment">
                                    <div class="sub-header">{{size.name}}</div>
                                    <div class="sub-content">
                                        {{size.value}}
                                    </div>
                                </div>
                            </template>

                        </div>

                    </template>

                    <div class="content-row">

                        <div class="column-block">
                            <div class="sub-header">Cycle Time</div>
                            <div class="sub-content">
                                {{item.cycletime}} days
                            </div>
                        </div>

                        <template is="dom-if" if="{{item.customfields.additionalEstimatedHours}}">
                            <div class="column-block">
                                <div class="sub-header">{{item.customfields.additionalEstimatedHours.name}}</div>
                                <div class="sub-content">
                                    <span>{{item.customfields.additionalEstimatedHours.value}}</span>
                                </div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{item.release}}">
                            <div class="column-block">
                                <div class="sub-header">Release</div>
                                <div class="sub-content">
                                    <span>{{item.release.name}}</span>
                                </div>
                            </div>
                        </template>

                    </div>

                    <template is="dom-if" if="{{issueBlocked(item)}}">
                        <div class="content-row">
                            <div class="column-block">
                                <div class="sub-header">Last Block Reason</div>
                                <div class="sub-content">
                                    <textarea class="last-block-reason-textarea" disabled>{{item.customfields.lastBlockReason}}</textarea>
                                </div>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="{{shouldShowSubtasks}}">
                        <div class="content-row">

                            <div class="column-block">
                                <div class="sub-header">{{showHeaderSubtasks(item)}}</div>
                                <div id="subtasks_content" class="sub-content">
                                    <div class="scroll">
                                        <template is="dom-repeat" items="{{subtasks}}" as="subtask">
                                            <paper-material class="subtaskPanel" elevation="0">
                                                <paper-button class="subtaskLink" on-tap="openJira"  data-issue-key$="{{subtask.issueKey}}">
                                                    {{subtask.issueKey}}
                                                </paper-button>
                                                {{subtask.summary}}
                                            </paper-material>
                                        </template>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </template>

                    <template is="dom-if" if="{{shouldShowTimetracking}}">

                        <div class="content-row">

                            <div class="column-block">
                                <div class="sub-header">Effort</div>
                                <template is="dom-if" if="{{!isUpdating}}">
                                    <div id="timetracking_content" class="sub-content">
                                        <template is="dom-if" if="{{timetracking}}">
                                            <span>[[timetrackingLabel]]</span>
                                            <paper-progress id="timeTracking" min="0"
                                                            max="[[timetracking.originalEstimateMinutes]]"
                                                            value="[[timetracking.timeSpentMinutes]]"
                                                            class$="{{getTimeTrackingColor()}}"></paper-progress>
                                        </template>
                                        <template is="dom-if" if="{{!timetracking}}">
                                            <paper-spinner active="true" alt="Loading..."></paper-spinner>
                                        </template>
                                    </div>
                                </template>
                            </div>

                        </div>

                    </template>

                </div>

                <template is="dom-if" if="{{errorMessage}}">
                    <div class="message-box message-box--error">
                        <paper-icon-button class="message-box__icon" icon="error" title="Error Icon"></paper-icon-button>
                        <p class="message-box__message">{{errorMessage}}</p>
                        <paper-icon-button class="message-box__close" icon="close" title="Close error" on-tap="_closeErrorMessage"></paper-icon-button>
                    </div>
                </template>

                <template is="dom-if" if="{{isUpdating}}">
                    <div class="message-box message-box--updating">
                        <paper-spinner class="message-box__icon" active="true" alt="Updating..."></paper-spinner>
                        <p class="message-box__message">Updating...</p>
                    </div>
                </template>

                <template is="dom-if" if="{{!isUpdating}}">

                    <div class="custom-footer">

                        <div id="transitions_content" class="custom-footer-buttons">

                            <paper-button disabled="{{isAlreadyAssignedToLoggedUser(item)}}" id="assignButton" raised class="colorful" on-tap="assignIssue" title="Assign to me">
                                Assign to me
                            </paper-button>

                            <template is="dom-if" if="{{hasRecords(transitions)}}">
                                <template id="issueTransitions" is="dom-repeat" items="{{transitions}}" as="transition">
                                    <paper-button data-transition-name$='{{transition.name}}' data-transition-id$='{{transition.id}}' data-transition-to-status-id$='{{transition.to.id}}' raised class="colorful" on-tap="requestTransition">
                                        {{transition.name}}
                                    </paper-button>
                                </template>
                            </template>

                            <template is="dom-if" if="{{canBlock}}">
                                <paper-button id="blockButton" raised class="colorful" on-tap="block" title="Block">
                                    Block
                                </paper-button>
                            </template>

                            <template is="dom-if" if="{{canUnblock}}">
                                <paper-button id="unblockButton" raised class="colorful" on-tap="unblock" title="Unblock">
                                    Unblock
                                </paper-button>
                            </template>

                            <template is="dom-if" if="{{!hasRecords(transitions)}}">
                                <paper-spinner active="true" alt="Loading..."></paper-spinner>
                            </template>

                        </div><!-- #transitions_content -->

                    </div><!-- .custom-footer -->

                </template>

            </paper-card>
        </paper-dialog>
        <transition-required-modal id="transitionRequiredDialog"></transition-required-modal>
        <confirm-modal id="confirmModal"></confirm-modal>
        <fields-required-modal id="fieldsRequiredDialog"></fields-required-modal>
        <issue-new-task id="dialogNewTask" item="{{item}}"></issue-new-task>
    </template>

    <script>
        (function () {
            Polymer({
                is: 'issue-detail',

                properties: {
                    item: {
                        type: Object,
                        notify: true
                    },

                    timetracking: {
                        type: Object,
                        notify: true
                    },

                    transitions: {
                        type: Array,
                        value: []
                    },

                    subtasks: {
                        type: Object,
                        notify: true
                    },

                    resolution: {
                        type: Object,
                        notify: true
                    },

                    shouldShowTimetracking: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    timetrackerBlown: {
                        type: Boolean,
                        notify: true
                    },

                    timetrackingLabel: {
                        type: String,
                        notify: true
                    },

                    shouldShowSubtasks: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    showFieldsRequiredDialog: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    isUpdating: {
                        type: Boolean
                    },

                    errorMessage: {
                        type: String,
                        value: null
                    },

                    canBlock: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    canUnblock: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    updatedIssue: {
                        type: Object,
                        value: null
                    },

                    issueChangeStateClass: {
                        type: String,
                        value: ''
                    },

                    localStates: {
                        type: Object,
                        notify: true
                    }

                },

                observers: [
                    '_resizeModal(subtasks, timetracking, isUpdating, errorMessage)',
                    '_updateIssueLocalState(localStates.*)'
                ],

                attached: function() {
                    var self = this;
                    self.isObserving = false;
                    new MutationObserver(function(mutations) {
                        if (!self.isObserving)
                            return;
                        mutations.forEach(function(mutation) {
                           console.log(mutation.target);
                           if (mutation.type == 'characterData') {
                               flash($(mutation.target.parentElement), 'yellow')
                           }
                           else
                               flash($(mutation.target), 'yellow')
                        });
                        self.isObserving = false;
                    }).observe(Polymer.dom(this).node, {subtree: true, childList: true, characterData: true})
                },

                computeTimeTrackingLabel: function () {
                    this.timetrackingLabel = this.parseMinutesToHours(this.timetracking.timeSpentMinutes) + '/' + this.parseMinutesToHours(this.timetracking.originalEstimateMinutes);
                },

                parseMinutesToHours: function (minutes) {
                    if (minutes == 0)
                        return '0h';

                    var hours = Math.floor(minutes / 60);
                    var min = minutes % 60;

                    return (hours > 0 ? hours + 'h ' : '') + (min > 0 ? min + 'm' : '');
                },

                timetrackingCallback: function (timetracking) {
                    this.timetracking = timetracking.detail.response;
                    this.shouldShowTimetracking = true;
                    this.updateTimetrackerColor();
                    this.computeTimeTrackingLabel();
                },

                showHeaderSubtasks: function (item) {
                    if (this.item.type == ISSUETYPE_ID.DEMANDA)
                        return "Tasks";
                    else
                        return "Sub-Tasks";
                },

                hideTimetracking: function () {
                    this.shouldShowTimetracking = false;
                },

                getUriImage: function (issue) {
                    return 'images/projetos/logo_' + issue.project.toLowerCase() + '.png';
                },

                assignIssue: function () {
                    var self = this;
                    var issueBefore = this.item;
                    var issue = clone(this.item);

                    var requestBody = issue.issueKey;
                    $.ajax({
                        url: '/ws/issues/assign',
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        data: requestBody,
                        success: function (issueFromServer) {
                            self._setIssueLocalStateAndFireUpdated(issueFromServer, false, null, 'UPDATED');
                            if(self._isOpenedAndIsTheSameIssue(issueFromServer.issueKey))
                                self.setCard(issueFromServer);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.error(errorThrown);
                            var responseMessage = jqXhr.responseJSON.message;
                            var toastMessage = 'Assign to me on issue "' + issueBefore.issueKey + '" failed: ' + responseMessage;
                            self._setIssueLocalStateAndFireUpdated(issueBefore, false, toastMessage, 'UPDATED');

                            if(self._isOpenedAndIsTheSameIssue(issueBefore.issueKey)) {
                                self.item = issueBefore;
                            } else {
                                self.fire("iron-signal", {name:"show-issue-error-message", data: {
                                        issueKey: issueBefore.issueKey,
                                        errorMessage: toastMessage
                                    }});
                            }
                        },
                        async: true
                    });

                    var current = issue.assignee;
                    var assignee = taskboard.getLoggedUser().name;
                    if(current != assignee) {
                        var coAssignees = issue.subResponsaveis.split(",");
                        coAssignees = _.without(coAssignees, assignee, "");
                        if(current && !_.contains(coAssignees, current))
                            coAssignees.push(current);

                        issue.assignee = assignee;
                        issue.subResponsaveis = coAssignees.join();
                    }
                    self._setIssueLocalStateAndFireUpdated(issue, true, null, 'UPDATED');
                    this.item = issue;
                },

                block: function () {
                    var self = this;
                    self._setIssueLocalState(self.item, true, null);
                    var callback = function(issue) {
                        $.ajax({
                            url: '/ws/issues/block-task/' + issue.issueKey,
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            data: issue.customFields[CUSTOMFIELD.LAST_BLOCK_REASON],
                            success: function () {
                                location.reload(true);
                            },
                            error: function (jqXhr, textStatus, errorThrown) {
                                console.error(errorThrown);
                                var errorMessage = jqXhr.responseJSON.message;
                                self._setIssueLocalState(self.item, false, errorMessage);
                            },
                            async: true
                        });
                    };

                    $.ajax({
                        url: '/ws/field/' + CUSTOMFIELD.LAST_BLOCK_REASON,
                        type: 'get',
                        success: function(data) {
                            var fields = [{id: CUSTOMFIELD.LAST_BLOCK_REASON,
                                           name: data.name,
                                           type: TYPE_FIELD.TEXTAREA}];
                            self.$.fieldsRequiredDialog.openDialog(fields, "Block", self.item, callback);
                            self._setIssueLocalState(self.item, false, null);
                        },
                        error: function(jqXhr, textStatus, errorThrown) {
                            console.error(errorThrown);
                            var errorMessage = jqXhr.responseJSON.message;
                            self._setIssueLocalState(self.item, false, errorMessage);
                        }
                    });
                },

                unblock: function () {
                    var self = this;
                    self._setIssueLocalState(self.item, true, null);
                    $.ajax({
                        url: '/ws/issues/unblock-task/' + self.item.issueKey,
                        type: 'get',
                        success: function () {
                            location.reload(true);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.error(errorThrown);
                            var errorMessage = jqXhr.responseJSON.message;
                            self._setIssueLocalState(self.item, false, errorMessage);
                        },
                        async: true
                    });
                },

                isAlreadyAssignedToLoggedUser: function(item) {
                    return item.assignee === taskboard.getLoggedUser().name;
                },

                requestTransition: function (e) {
                    var self =  this;
                    var issue = self.item;
                    var transition = this.getTransitionById(e.target.dataset.transitionId);
                    var status = taskboard.getStatus(e.target.dataset.transitionToStatusId);
                    var fieldsTransitions = self.getFieldsTransitions(transition);
                    var text = "Do you want to execute transition \""+ transition.name + "\"?";
                    var callback = function(issue, fieldValuesRequired){
                        if(self.isResolutionRequired(transition))
                            self.doResolution(transition, issue, status, fieldValuesRequired);
                        else
                            self.doTransition(transition, issue, status, null, fieldValuesRequired);
                    }
                    if(self.showFieldsRequiredDialog)
                        self.$.transitionRequiredDialog.openDialog(fieldsTransitions, transition.name, issue, callback);
                    else
                        self.$.confirmModal.openDialog("Confirmation", text, callback);
                    self.showFieldsRequiredDialog = false;
                },

                getFieldsTransitions: function(transition){
                    var self = this;
                    var fieldsTransitions = [];
                    if (transition){
                        Object.values(transition.fields).forEach( field => {
                            if(field.required && !isFieldNameEquals(field.name, taskboard.getResolutionFieldName())){
                                self.showFieldsRequiredDialog = true;
                                fieldsTransitions.push(field);
                            }
                        });
                        if(TRANSITION_REQUIRED_COMMENT.indexOf(transition.name) != -1)
                           self.showFieldsRequiredDialog = true;
                    }
                    return fieldsTransitions;
                },

                isResolutionRequired: function (transition) {
                    if (!transition)
                        return false;
                    var found = Object.values(transition.fields).find( field => field.required && isFieldNameEquals(field.name, taskboard.getResolutionFieldName()) );
                    return found != undefined;
                },

                doTransition: function (transition, issue, status, fieldValuesRequired) {
                    var self = this;
                    if(!issue)
                        issue = this.item;
                    var issueBeforeTransition = clone(issue);
                    var params = {issueKey: issue.issueKey, transitionId: transition.id, fields: fieldValuesRequired};

                    $.ajax({
                        url: '/ws/issues/transition',
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(params),
                        success: function (issueFromServer, textStatus, jQxhr) {
                            self._setIssueLocalStateAndFireUpdated(issueFromServer, false, null, 'TRANSITION');
                            if(self._isOpenedAndIsTheSameIssue(issueFromServer.issueKey))
                                self.setCard(issueFromServer);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            var responseMessage = jqXhr.responseJSON.message;
                            var toastMessage = 'Transition of issue "' + issueBeforeTransition.issueKey + '" to "' + transition.name +  '" failed: ' + responseMessage;
                            self._setIssueLocalStateAndFireUpdated(issueBeforeTransition, false, toastMessage, 'TRANSITION');

                            if(self._isOpenedAndIsTheSameIssue(issueBeforeTransition.issueKey))
                                self.setCard(issueBeforeTransition);

                            self.fire("iron-signal", {name:"show-issue-error-message", data: {
                                    issueKey: issueBeforeTransition.issueKey,
                                    errorMessage: toastMessage
                                }});
                        },
                        async: true
                    });

                    this.close();
                    issue.status = status.id;
                    this._setIssueLocalStateAndFireUpdated(clone(issue), true, null, 'TRANSITION');
                },

                doResolution: function (transition, issue, status, fieldValuesRequired) {
                    var self = this;
                    $.ajax({
                        url: '/ws/issues/resolutions/'+transition.name,
                        type: 'get',
                        success: function (data, textStatus, jQxhr) {
                            copyProperties(fieldValuesRequired, {resolution: data});
                            self.doTransition(transition, issue, status, fieldValuesRequired);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.error(jqXhr);
                            self.set('errorMessage', jqXhr.responseJSON.message);
                        },
                    });
                },

                shouldShowNewSubtask: function (item) {
                    var issueTypes = JSON.parse(localStorage.getItem("issueTypes"));
                    var issueConf = JSON.parse(localStorage.getItem("issueTypeConfig"));

                    for (x in issueConf)
                        if (x == this.item.type)
                            return true;
                    return false;
                },

                opendialog: function (item) {
                    this.isObserving = false;
                    this.setCard(item);
                    this.$.modal.open();
                    this.isOpen = true;
                },

                _resizeModal: function(subtasks, timetracking, isUpdating, errorMessage) {
                    this.$.modal.notifyResize();
                },

                setCard: function(item) {
                    var startDateStep = new Date(item.startDateStepMillis);
                    item.cycletime = cycleTime.getCycleTime(startDateStep, new Date()).toFixed(2);
                    
                    this.item = item;
                    $(this.$.modal).css('background-color', this.item.color);

                    if(!this.isUpdating) {
                        this.$.ajaxTimetracking.generateRequest();
                        this.$.ajaxTransitions.generateRequest();
                    }
                    this.subtasks = item.subtasks;
                    this.shouldShowSubtasks = typeof this.subtasks !== undefined && this.subtasks.length > 0;

                    this.canBlock = !this.issueBlocked(item) && !this.issueFechada(item);
                    this.canUnblock = this.issueBlocked(item) && !this.issueFechada(item);
                    this.issueChangeStateClass = '';
                    this.updatedIssue = null;

                    this._updateIssueLocalState();
                },

                getAssignees: function (item) {
                    var assignees = "";

                    if (item.subResponsaveis) {
                        if (item.subResponsaveis.indexOf(item.assignee) < 0) {
                            assignees = item.assignee + ',' + item.subResponsaveis;
                        } else {
                            assignees = item.subResponsaveis;
                        }
                    } else {
                        assignees = item.assignee;
                    }

                    if (!assignees)
                        return [];

                    return assignees.split(',');
                },

                isInvalidTeam: function(item) {
                    return taskboard.isInvalidTeam(item.teams);
                },

                getTitleIconInvalidTeam: function(item) {
                    return "Assignee should be in one of these teams: " + taskboard.getTeamsOfProject(item.projectKey);
                },

                getDescription: function (issue) {
                    return issue.description ? jira2md.to_markdown(issue.description) : 'N/A';
                },

                hasRecords: function (records) {
                    return records && records.length > 0;
                },

                updateTimetrackerColor: function () {
                    if (this.timetracking.originalEstimateMinutes)
                        this.timetrackerBlown = this.timetracking.timeSpentMinutes > this.timetracking.originalEstimateMinutes;
                    else
                        this.timetrackerBlown = false;
                },

                getTimeTrackingColor: function() {
                    return this.timetrackerBlown ? 'red' : 'green';
                },

                openDialogNewTask: function () {
                    this.$.dialogNewTask.opendialog(this.item);
                    this.close();
                    this.isOpen = false;
                },

                openJira: function (event) {
                    event.stopPropagation();
                    var issueKey = event.target.getAttribute('data-issue-key');
                    var win = window.open(window.urlJira + '/browse/' + issueKey, '_blank');
                },

                close: function() {
                    this._beforeClose();
                    this.$.modal.close();
                },

                _beforeClose: function () {
                    this.isOpen = false;
                    this.isObserving = false;
                },

                _afterClose: function () {
                    this.timetracking = {};
                    this.transitions = [];
                    this.subtasks = null;
                    this.resolution = null;
                    this.showFieldsRequiredDialog = false;
                    this.timetracking = null;

                    this.shouldShowTimetracking = true;
                    this.shouldShowSubtasks = true;

                    this.isUpdating = false;
                    this.errorMessage = null;
                },

                issueFechada: function (item) {
                    return STATUSES_COMPLETED_IDS.indexOf(item.status) != -1;
                },

                issueCancelada: function (item) {
                    return STATUSES_CANCELED_IDS.indexOf(item.status) != -1;
                },

                issueBlocked: function (item) {
                    return this.item.customfields.impedido;
                },

                getIssueTypeName: function(issueTypeId) {
                    return taskboard.getIssueTypeName(issueTypeId);
                },

                getIssueTypeImage: function(issue) {
                    return issue.typeIconUri.replace('xsmall', 'medium');
                },

                getStatusName: function(statusId) {
                    return taskboard.getStatusName(statusId);
                },

                updateIssue: function(event) {
                    if (!this.isOpen)
                        return;

                    if (event.detail.source === 'client')
                        return;

                    if (this.item != null && event.detail.issue.issueKey !== this.item.issueKey)
                        return;

                    this.isObserving = true;
                    this.set('updatedIssue', event.detail.issue);
                    this.set('issueChangeStateClass', 'visible-glasspane');
                },

                refreshIfUpdated: function() {
                    if (this.updatedIssue && this._isOpenedAndIsTheSameIssue(this.updatedIssue.issueKey))
                        this.setCard(this.updatedIssue);
                },

                getTransitionById: function(transitionId) {
                    return this.transitions.find( transition => transition.id == transitionId );
                },

                _closeErrorMessage: function() {
                    this._setIssueLocalState(this.item, this.isUpdating, null);
                    this.fire("iron-signal", {name:"close-issue-error-message", data: this.item.issueKey });
                },

                _setIssueLocalStateAndFireUpdated: function(issue, isUpdating, errorMessage, eventType) {
                    this._setIssueLocalState(issue, isUpdating, errorMessage);
                    taskboard.fireIssueUpdated('client', this, issue, eventType);
                },

                _setIssueLocalState: function(issue, isUpdating, errorMessage) {
                    if( this.localStates.issues[issue.issueKey] ) {
                        this.set('localStates.issues.' + issue.issueKey + '.isUpdating', isUpdating);
                        this.set('localStates.issues.' + issue.issueKey + '.errorMessage', errorMessage);
                    } else {
                        var issueLocalState = new IssueLocalStateBuilder(issue.issueKey).isUpdating(isUpdating).errorMessage(errorMessage).build();
                        this.set('localStates.issues.' + issueLocalState.getIssueKey(), issueLocalState);
                    }
                },

                _updateIssueLocalState: function() {
                    if (!this.item)
                        return;
                    var isUpdating = false;
                    var errorMessage = null;

                    var issueLocalState = this.localStates.issues[this.item.issueKey];
                    if (issueLocalState) {
                        isUpdating = issueLocalState.isUpdating;
                        errorMessage = issueLocalState.errorMessage;
                    }

                    var step = taskboard.getIssueStep(this.item);
                    if (step !== null) {
                        var stepLocalState = this.localStates.steps[step.id];
                        if (stepLocalState)
                            isUpdating = isUpdating || stepLocalState.isUpdating;
                    }

                    this.set('isUpdating', isUpdating);
                    this.set('errorMessage', errorMessage);
                },

                _isOpenedAndIsTheSameIssue: function(issueKey) {
                    return this.isOpen && (this.item && this.item.issueKey == issueKey);
                },

            });

        })();
    </script>

</dom-module>
