<!--
  [LICENSE]
  Taskboard
  - - -
  Copyright (C) 2015 - 2016 Objective Solutions
  - - -
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
  [/LICENSE]
  -->
<dom-module id="issue-detail">

    <style>
        :host {
        }

        .card-custom {
            background: transparent;
            width: 100%;
            min-height: 360px;
            padding: 20px;
            margin: 0;
        }

        .half-column {
        }

        .card-header-custom {
            width: 100%;
            margin-bottom: 30px;
            font-size: 24px;
            display: flex;
        }

        .card-header-info {
            flex: 1;
        }

        .card-header-breadcrumb {
            margin-bottom: 10px;
            font-size: 15px;
        }

        .arrow {
            margin: 0 5px;
        }

        paper-button.headerLink {
            min-width: initial;
            margin: 0px;
            padding: 0px;
            font-weight: normal;
        }

        .issue-key-link {
            font-weight: 600;
        }

        .card-header-title paper-button {
            text-transform: none;
            font-size: 25px;
            line-height: normal;
            display: block;
        }

        .sub-header {
            line-height: normal;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 600;
        }

        .content-row {
            display: flex;
            margin-top: 20px;
            margin-left: -10px;
            margin-right: -10px;
        }
        
        .content-row:first-child {
            margin-top: 0;
        }

        .column-block {
            flex: 1;
            margin-left: 10px;
            margin-right: 10px;
        }
        
        .column-block.top-bottom-alignment {
            display: flex;
            flex-direction: column;
        }

        .column-block.top-bottom-alignment .sub-content {
            margin-top: auto;
        }

        .sub-content {
            font-size: 15px;
        }

        paper-button {
            margin-bottom: 12px;
        }

        .card-header-buttons {
            padding: 0;
            margin-left: auto;
        }

        .icon-text {
            display: flex;
            align-items: center;
        }

        .icon-text .icon {
            margin-right: 5px;
            filter: initial;
            bottom: initial;
        }

        .assign-icon {
            height: 17px;
            width: 18px;
        }

        paper-material, paper-button {
            box-shadow: none !important;
        }

        paper-button.colorful {
            color: #4285f4;
        }

        paper-button[raised].colorful {
            background: #4285f4;
            color: #fff;
        }

        paper-button[toggles] {
            transition: all 0.3s;
        }

        paper-button[toggles][active] {
            background-color: rgba(0, 0, 0, 0.25);
        }

        paper-button[toggles][active].colorful {
            background-color: rgba(66, 133, 244, 0.25);
        }

        paper-button[toggles][active][raised].colorful {
            background-color: rgba(66, 133, 244, 0.75);
        }

        paper-button.parentLink {
            font-size: 15px;
            font-weight: 600;
            margin: 0px;
            padding: 0px;
            text-align: left;
            color: #3B50C7;
        }

        paper-button.subtaskLink {
            font-size: inherit;
            font-weight: 600;
            color: #3B50C7;
            margin: 0 5px 0 0;
            padding: 0;
            display: inline;
        }

        paper-material.subtaskPanel {
            margin-top: 5px;
        }

        paper-material.subtaskPanel:first-child {
            margin-top: 0;
        }

        paper-material.highlightPanel {
            padding: 4px;
            padding-left: 8px;
            padding-right: 8px;
            border-radius: 5px;
            color: white;
            background-color: #7180D6;
            margin: 2px;
        }

        .red {
            --paper-progress-active-color: var(--paper-red-500);
            --paper-progress-secondary-color: var(--paper-red-100);
        }

        .green {
            --paper-progress-active-color: var(--paper-light-green-500);
            --paper-progress-secondary-color: var(--paper-light-green-100);
        }

        .content-box {
        }
        
        #timetracking_content {
            height: 40px;
        }

        #timetracking_content paper-progress {
            width: 100%;
            --paper-progress-height: 10px;
            margin-top: 5px;
        }

        #modal {
            background: transparent;
            min-width: 600px;
            min-height: 360px;
            margin: 0;
            display: block;
            font-family: inherit;
        }

        #loadCard {
            margin-top: 12px;
        }

        .bottom {
            margin: 4px;
            display: flex;
        }

        .icon-blocked {
            color: #F78181;
            bottom: 3px;
            -webkit-filter: drop-shadow(1px 1px 1px #616161);
            filter: drop-shadow(1px 1px 1px #616161);
        }

        .icon-cancelada {
            color: #FFCD00;
            bottom: 3px;
            -webkit-filter: drop-shadow(1px 1px 1px #616161);
            filter: drop-shadow(1px 1px 1px #616161);
        }

        .info {
            -webkit-filter: drop-shadow(1px 1px 1px #616161);
            filter: drop-shadow(1px 1px 1px #616161);
        }

        .error-message {
            white-space: pre;
            margin-left: 10px;
            color: red;
            font-weight: bold;
            width: 100%;
        }

        .buttonClose {
            min-width: auto;
            display: inline;
            padding: 0;
            margin: 0;
        }

        textarea {
            height: 30px;
            width: 100%;
            border: none;
            background-color: inherit;
            margin-top: 7px;
        }

        .icon img {
            display: block;
        }

        .icon-small {
            width: 25px;
            height: 25px;
        }

        .scroll {
            padding: 10px;
            overflow: auto;
            overflow-x: hidden;
            max-height: 150px;
            max-width: 100%;
            background-color: white;
        }

        .custom-footer {
            margin-top: 30px;
        }

        .custom-footer-buttons {
            display: flex;
            margin-left: -5px;
            margin-right: -5px;
        }

        .custom-footer-buttons paper-button {
            padding: 5px 10px;
            margin: 0 5px;
            text-transform: none;
            text-align: center;
        }

        paper-spinner[aria-hidden=true] {
            display: none;
        }

        .last-block-reason-textarea {
            border: 1px solid #CCC;
            background: #FFF;
            width: 100%;
            min-height: 54px;
            min-width: 100%;
            max-width: 100%;
            padding: 5px;
            margin: 0px;
            font-size: inherit;
            line-height: normal;
            font-family: inherit;
            color: inherit;
        }

        .last-block-reason-textarea:disabled {
            background: #DDD;
            color: #555;
        }

    </style>

    <template>
        <iron-ajax id="ajaxTransitions"
                   method="POST"
                   url="/ws/issues/transitions"
                   body="{{item}}"
                   content-type='application/json'
                   headers='{"Content-Type": "application/json"}'
                   last-response="{{transitions}}"
                   on-response="hideSpinnerTransitions"></iron-ajax>
        <iron-ajax id="ajaxSubtasks"
                   method="POST"
                   url="/ws/issues/subtasks"
                   body="{{item}}"
                   content-type='application/json'
                   headers='{"Content-Type": "application/json"}'
                   last-response="{{subtasks}}"
                   on-response="subtasksCallback"></iron-ajax>
        <iron-ajax id="ajaxTimetracking"
                   method="POST"
                   url="/ws/issues/timetracking"
                   body="{{item}}"
                   content-type='application/json'
                   headers='{"Content-Type": "application/json"}'
                   last-response="{{timetracking}}"
                   on-response="timetrackingCallback"
                   on-error="hideTimetracking"></iron-ajax>
        <paper-dialog id="modal" with-backdrop modal
                      entry-animation="scale-up-animation" exit-animation="fade-out-animation"
                      on-iron-overlay-closed="clearProperties">
            <paper-card class="card-custom">

                <div class="card-header-custom">
                    <div class="card-header-info">
                        <div class="card-header-breadcrumb">
                            <span class="project-title">
                                {{item.project}}
                            </span>
                            <template is="dom-if" if="{{item.parent}}">
                                <span class="parent-key">
                                    <span class="arrow">></span>
                                    <paper-button class="parentLink" on-tap="openJira" data-issue-key$="{{item.parent}}">{{item.parent}}</paper-button>
                                </span>
                            </template>
                            <span class="issue-key">
                                <span class="arrow">></span>
                                <paper-button class="headerLink issue-key-link" on-tap="openJira" data-issue-key$="{{item.issueKey}}">{{item.issueKey}}</paper-button>
                            </span>
                        </div>
                        <div class="card-header-title">
                            <paper-button class="headerLink" on-tap="openJira" data-issue-key$="{{item.issueKey}}">{{item.summary}}</paper-button>
                        </div>
                    </div>
                    <div class="card-header-buttons">
                        <paper-button class="buttonClose" dialog-confirm autofocus>
                            <iron-icon icon="clear"></iron-icon>
                        </paper-button>
                    </div>
                </div>

                <div class="content-box">
                    <div class="content-row">

                        <div class="column-block issue-type">
                            <div class="sub-header">Issue type</div>
                            <div class="icon-text">
                                <div class="icon">
                                    <img id="issueTypeIcon" class="icon-small"
                                         title$="{{getIssueTypeName(item.type)}}" src$="{{getIssueTypeImage(item)}}"/>
                                </div>
                                <div class="text">
                                    {{getIssueTypeName(item.type)}}
                                </div>
                            </div>
                        </div>

                        <template is="dom-if" if="{{issueBlocked(item)}}">
                            <div class="column-block item-icon-text blocked">
                                <div class="sub-header">Blocked</div>
                                <div class="icon-text">
                                    <iron-icon class="icon icon-blocked icon-small" icon="icons:block"></iron-icon>
                                    <div class="text">
                                        Blocked
                                    </div>
                                </div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{issueCancelada(item)}}">
                            <div class="column-block item-icon-text-canceled">
                                <div class="sub-header">Canceled</div>
                                <div class="icon-text">
                                    <iron-icon class="icon icon-cancelada icon-small" icon="warning"></iron-icon>
                                    <div class="text">
                                        Canceled
                                    </div>
                                </div>
                            </div>
                        </template>

                        <div class="column-block">
                            <div class="sub-header">Status</div>
                            <div class="sub-content horizontal layout">
                                <paper-material class="highlightPanel">{{getStatusName(item.status)}}</paper-material>
                            </div>
                        </div>

                        <div class="column-block half-column">
                            <div class="sub-header">Class of Service</div>
                            <div class="sub-content">
                                {{item.customfields.classeDeServico}}
                            </div>
                        </div>

                    </div>

                    <div class="content-row">

                        <div class="column-block half-column">
                            <div class="sub-header">Assignees</div>
                            <div class="sub-content flex horizontal layout wrap">
                                <template is="dom-repeat" items="{{listaResponsaveis(item)}}" as="responsavel">
                                    <paper-material class="highlightPanel">{{responsavel}}</paper-material>
                                </template>
                            </div>
                        </div>

                    </div>

                    <div class="content-row">
                        <div class="column-block">
                            <div class="sub-header">Description</div>
                            <div>
                                {{getDescription(item)}}
                            </div>
                        </div>
                    </div>

                    <template is="dom-if" if="{{item.customfields.sizes.length}}">
                        <div class="content-row">

                            <template is="dom-repeat" items="{{item.customfields.sizes}}" as="size">
                                <div class="column-block top-bottom-alignment">
                                    <div class="sub-header">{{size.name}}</div>
                                    <div class="sub-content">
                                        {{size.value}}
                                    </div>
                                </div>
                            </template>

                        </div>

                    </template>

                    <div class="content-row">

                        <div class="column-block">
                            <div class="sub-header">Cycle Time</div>
                            <div class="sub-content">
                                {{item.cycletime}} days
                            </div>
                        </div>

                        <template is="dom-if" if="{{item.customfields.additionalEstimatedHours}}">
                            <div class="column-block">
                                <div class="sub-header">{{item.customfields.additionalEstimatedHours.name}}</div>
                                <div class="sub-content">
                                    <span>{{item.customfields.additionalEstimatedHours.value}}</span>
                                </div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{item.customfields.release}}">
                            <div class="column-block">
                                <div class="sub-header">{{item.customfields.release.name}}</div>
                                <div class="sub-content">
                                    <span>{{item.customfields.release.value}}</span>
                                </div>
                            </div>
                        </template>

                    </div>

                    <template is="dom-if" if="{{issueBlocked(item)}}">
                        <div class="content-row">
                            <div class="column-block">
                                <div class="sub-header">Last Block Reason</div>
                                <div class="sub-content">
                                    <textarea class="last-block-reason-textarea" disabled>{{item.customfields.lastBlockReason}}</textarea>
                                </div>
                            </div>
                        </div>
                    </template>

                    <template is="dom-if" if="{{shouldShowSubtasks}}">
                        <div class="content-row">

                            <div class="column-block">
                                <div class="sub-header">{{showHeaderSubtasks(item)}}</div>
                                <div id="subtasks_content" class="sub-content">
                                    <div class="scroll">
                                        <template is="dom-repeat" items="{{subtasks}}" as="subtask">
                                            <paper-material class="subtaskPanel" elevation="0">
                                                <paper-button class="subtaskLink" on-tap="openJira"  data-issue-key$="{{subtask.issueKey}}">
                                                    {{subtask.issueKey}}
                                                </paper-button>
                                                {{subtask.summary}}
                                            </paper-material>
                                        </template>
                                        <paper-spinner id="loadSubtasks" active alt="Loading..."></paper-spinner>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </template>

                    <template is="dom-if" if="{{shouldShowTimetracking}}">

                        <div class="content-row">

                            <div class="column-block">
                                <div class="sub-header">Effort</div>
                                <div id="timetracking_content" class="sub-content">
                                    <template is="dom-if" if="{{timetracking}}">
                                        <span>[[timetrackingLabel]]</span>
                                        <paper-progress id="timeTracking" min="0"
                                                        max="[[timetracking.originalEstimateMinutes]]"
                                                        value="[[timetracking.timeSpentMinutes]]"
                                                        class$="{{getTimeTrackingColor()}}"></paper-progress>
                                    </template>
                                    <paper-spinner id="loadTimetracking" active alt="Loading..."></paper-spinner>
                                </div>
                            </div>

                        </div>

                    </template>

                    <span class="error-message" hidden$="{{!errorMessage}}">{{errorMessage}}</span>
                </div>

                <div class="custom-footer">

                    <div id="transitions_content" class="custom-footer-buttons">

                        <paper-button id="assignButton" raised class="colorful" on-tap="assignIssue" title="Assign to me">
                            Assign to me
                        </paper-button>

                        <template is="dom-if" if="{{hasRecords(transitions)}}">
                            <template id="issueTransitions" is="dom-repeat" items="{{transitions}}" as="transition">
                                <paper-button data-transition-name$='{{transition.name}}' raised class="colorful" on-tap="requestTransition" data-args={{transition.name}}>
                                    {{transition.name}}
                                </paper-button>
                            </template>
                        </template>

                        <template is="dom-if" if="{{canBlock}}">
                            <paper-button id="blockButton" raised class="colorful" on-tap="block" title="Block">
                                Block
                            </paper-button>
                        </template>

                        <template is="dom-if" if="{{canUnblock}}">
                            <paper-button id="unblockButton" raised class="colorful" on-tap="unblock" title="Unblock">
                                Unblock
                            </paper-button>
                        </template>

                        <paper-spinner id="loadTransitions" active alt="Loading..."></paper-spinner>
                    </div>

                </div>

            </paper-card>
        </paper-dialog>
        <transition-required-modal id="transitionRequiredDialog"></transition-required-modal>
        <confirm-modal id="confirmModal"></confirm-modal>
        <fields-required-modal id="fieldsRequiredDialog"></fields-required-modal>
        <issue-new-task id="dialogNewTask" item="{{item}}"></issue-new-task>
    </template>

    <script>
        (function () {
            Polymer({
                is: 'issue-detail',

                properties: {
                    item: {
                        type: Object,
                        notify: true
                    },

                    timetracking: {
                        type: Object,
                        notify: true
                    },

                    transitions: {
                        type: Object,
                        notify: true
                    },

                    subtasks: {
                        type: Object,
                        notify: true
                    },

                    resolution: {
                        type: Object,
                        notify: true
                    },

                    shouldShowTimetracking: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    timetrackerBlown: {
                        type: Boolean,
                        notify: true
                    },

                    timetrackingLabel: {
                        type: String,
                        notify: true
                    },

                    shouldShowSubtasks: {
                        type: Boolean,
                        value: true,
                        notify: true
                    },

                    showFieldsRequiredDialog: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    errorMessage: {
                        type: String,
                        value: null
                    },

                    canBlock: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },

                    canUnblock: {
                        type: Boolean,
                        value: false,
                        notify: true
                    }

                },

                observers: [
                    'doTransitionWithResolution(resolution.*)'
                ],

                computeTimeTrackingLabel: function () {
                    this.timetrackingLabel = this.parseMinutesToHours(this.timetracking.timeSpentMinutes) + '/' + this.parseMinutesToHours(this.timetracking.originalEstimateMinutes);
                },

                parseMinutesToHours: function (minutes) {
                    if (minutes == 0)
                        return '0h';

                    var hours = Math.floor(minutes / 60);
                    var min = minutes % 60;

                    return (hours > 0 ? hours + 'h ' : '') + (min > 0 ? min + 'm' : '');
                },

                subtasksCallback: function () {
                    this.$.modal.refit();
                    this.shouldShowSubtasks = this.hasRecords(this.subtasks);
                    if (this.$$('#loadSubtasks'))
                        this.$$('#loadSubtasks').active = false;
                },

                showSpinnerTransitions: function () {
                    this.$.modal.refit();
                    if (this.$$('#loadTransitions'))
                        this.$$('#loadTransitions').active = true;
                },

                hideSpinnerTransitions: function () {
                    this.$.modal.refit();
                    if (this.$$('#loadTransitions'))
                        this.$$('#loadTransitions').active = false;
                },

                timetrackingCallback: function (timetracking) {
                    this.$.modal.refit();
                    if (this.$$('#loadTimetracking'))
                        this.$$('#loadTimetracking').active = false;
                    this.timetracking = timetracking.detail.response;
                    this.shouldShowTimetracking = true;
                    this.updateTimetrackerColor();
                    this.computeTimeTrackingLabel();
                },

                showHeaderSubtasks: function (item) {
                    if (this.item.type == ISSUETYPE_ID.DEMANDA)
                        return "Tasks";
                    else
                        return "Sub-Tasks";
                },

                hideTimetracking: function () {
                    this.$.modal.refit();
                    this.shouldShowTimetracking = false;
                },

                getUriImage: function (issue) {
                    return 'images/projetos/logo_' + issue.project.toLowerCase() + '.png';
                },

                assignIssue: function () {
                    var self = this;
                    self.showSpinnerTransitions();

                    $.ajax({
                        url: '/ws/issues/assign',
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(this.item),
                        success: function (issue) {
                            taskboard.fireIssueUpdated('client', self, issue, 'UPDATED');
                            self.close();
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.error(errorThrown);
                            self.errorMessage = jqXhr.responseJSON.message;
                            self.hideSpinnerTransitions();
                        },
                        async: true
                    });
                },

                block: function () {
                    var self = this;
                    self.showSpinnerTransitions();
                    var callback = function(issue) {
                        self.showSpinnerTransitions();
                        $.ajax({
                            url: '/ws/issues/block-task/' + issue.issueKey,
                            type: 'post',
                            dataType: 'json',
                            contentType: 'application/json',
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            },
                            data: issue.customFields[CUSTOMFIELD.LAST_BLOCK_REASON],
                            success: function () {
                                location.reload(true);
                            },
                            error: function (jqXhr, textStatus, errorThrown) {
                                console.error(errorThrown);
                                self.errorMessage = jqXhr.responseJSON.message;
                                self.hideSpinnerTransitions();
                            },
                            async: true
                        });
                    };

                    $.ajax({
                        url: '/ws/field/' + CUSTOMFIELD.LAST_BLOCK_REASON,
                        type: 'get',
                        success: function(data) {
                            var fields = [{id: CUSTOMFIELD.LAST_BLOCK_REASON,
                                           name: data.name,
                                           type: TYPE_FIELD.TEXTAREA}];
                            self.$.fieldsRequiredDialog.openDialog(fields, "Block", self.item, callback);
                            self.hideSpinnerTransitions();
                        },
                        error: function(jqXhr, textStatus, errorThrown) {
                            console.error(errorThrown);
                            self.errorMessage = jqXhr.responseJSON.message;
                            self.hideSpinnerTransitions();
                        }
                    });
                },

                unblock: function () {
                    var self = this;
                    self.showSpinnerTransitions();
                    $.ajax({
                        url: '/ws/issues/unblock-task/' + self.item.issueKey,
                        type: 'get',
                        success: function () {
                            location.reload(true);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.error(errorThrown);
                            self.errorMessage = jqXhr.responseJSON.message;
                            self.hideSpinnerTransitions();
                        },
                        async: true
                    });
                },

                requestTransition: function (e) {
                    var self =  this;
                    var issue = self.item;
                    var transitionName = e.target.dataArgs;
                    var fieldsTransitions = self.getFieldsTransitions(transitionName);
                    var text = "Do you want to execute transition \""+ transitionName + "\"?";
                    var callback = function(issue, transitionValuesRequired){
                        if(self.hasResolutions(transitionName))
                            self.doResolution(transitionName, issue);
                        else
                            self.doTransition(transitionName, issue);
                    }
                    if(self.showFieldsRequiredDialog)
                        self.$.transitionRequiredDialog.openDialog(fieldsTransitions, transitionName, issue, callback);
                    else
                        self.$.confirmModal.openDialog("Confirmation", text, callback);
                    self.showFieldsRequiredDialog = false;
                },

                getFieldsTransitions: function(transitionName){
                    var self = this;
                    var fieldsTransitions = [];
                    for (var t = 0; t < self.transitions.length; t++) {
                       if (self.transitions[t].name == transitionName && self.transitions[t].fields.length != []){
                            for (var f = 0; f < self.transitions[t].fields.length; f++) {
                                if(self.transitions[t].fields[f].required && self.transitions[t].fields[f].id != "resolution"){
                                    self.showFieldsRequiredDialog = true;
                                    fieldsTransitions.push(self.transitions[t].fields[f]);
                                }
                            }
                            if(TRANSITION_REQUIRED_COMMENT.indexOf(transitionName) != -1)
                               self.showFieldsRequiredDialog = true;
                            return fieldsTransitions;
                        }
                    }
                },

                hasResolutions: function (transitionName) {
                    for (var t = 0; t < this.transitions.length; t++) {
                        if (this.transitions[t].name === transitionName) {
                            for (var f = 0; f < this.transitions[t].fields.length; f++) {
                                if (this.transitions[t].fields[f].id === "resolution" && this.transitions[t].fields[f].required) {
                                    return true;
                                }
                            }
                        }
                    }

                    return false;
                },

                doTransitionWithResolution: function () {
                    if (this.resolution !== null) {
                        this.doTransition(this.resolution.transition, this.resolution.resolution);
                    }
                },

                doTransition: function (transition, issue, resolution) {
                    var self = this;
                    if(issue == null)
                        issue = this.item;
                    var params = {transition: transition, resolution: resolution, issue: issue};
                    this.showSpinnerTransitions();
                    $.ajax({
                        url: '/ws/issues/transition',
                        type: 'post',
                        dataType: 'json',
                        contentType: 'application/json',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify(params),
                        success: function (issue, textStatus, jQxhr) {
                            taskboard.fireIssueUpdated('client', self, issue, 'TRANSITION');
                            self.close();
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            self.clearProperties();
                            self.errorMessage = jqXhr.responseJSON.message;
                            self.hideSpinnerTransitions();
                            console.error(jqXhr);
                        },
                        async: true
                    });
                },

                doResolution: function (transition, issue) {
                    var self = this;
                    $.ajax({
                        url: '/ws/issues/resolutions/'+transition,
                        type: 'get',
                        success: function (data, textStatus, jQxhr) {
                            self.doTransition(transition, issue, data);
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            self.errorMessage = jqXhr.responseJSON.message;
                            console.error(jqXhr);
                        },
                    });
                },

                shouldShowNewSubtask: function (item) {
                    var issueTypes = JSON.parse(localStorage.getItem("issueTypes"));
                    var issueConf = JSON.parse(localStorage.getItem("issueTypeConfig"));

                    for (x in issueConf)
                        if (x == this.item.type)
                            return true;
                    return false;
                },

                opendialog: function (item) {
                    this.item = item;
                    $(this.$.modal).css('background-color', this.item.color);
                    this.$.ajaxTimetracking.generateRequest();
                    this.$.ajaxTransitions.generateRequest();
                    this.$.ajaxSubtasks.generateRequest();
                    this.$.modal.toggle();
                    this.canBlock = !this.issueBlocked(item) && !this.issueFechada(item);
                    this.canUnblock = this.issueBlocked(item) && !this.issueFechada(item);
                },

                listaResponsaveis: function (item) {
                    var responsaveis = "";

                    if (item.subResponsaveis) {
                        if (item.subResponsaveis.indexOf(item.assignee) < 0) {
                            responsaveis = item.assignee + ',' + item.subResponsaveis;
                        } else {
                            responsaveis = item.subResponsaveis;
                        }
                    } else {
                        responsaveis = item.assignee;
                    }

                    var responsaveisArray = [];

                    if (!responsaveis) {
                        return responsaveisArray;
                    }

                    var values = responsaveis.split(',');

                    for (var i = 0; i < values.length; i++) {
                        responsaveisArray.push(values[i]);
                    }

                    return responsaveisArray;
                },

                getDescription: function (issue) {
                    return issue.description ? issue.description : 'N/A';
                },

                hasRecords: function (records) {
                    return records && records.length > 0;
                },

                updateTimetrackerColor: function () {
                    if (this.timetracking.originalEstimateMinutes)
                        this.timetrackerBlown = this.timetracking.timeSpentMinutes > this.timetracking.originalEstimateMinutes;
                    else
                        this.timetrackerBlown = false;
                },

                getTimeTrackingColor: function() {
                    return this.timetrackerBlown ? 'red' : 'green';
                },

                getIssueColor: function (issue) {
                    return 'background: ' + issue.color;
                },

                openDialogNewTask: function () {
                    this.$.dialogNewTask.opendialog(this.item);
                    this.close();
                },

                close: function() {
                    this.$.modal.close();
                },

                openJira: function (event) {
                    event.stopPropagation();
                    var issueKey = event.target.getAttribute('data-issue-key');
                    var win = window.open(window.urlJira + '/browse/' + issueKey, '_blank');
                },

                clearProperties: function () {
                    this.timetracking = {};
                    this.transitions = [];
                    this.subtasks = null;
                    this.resolution = null;
                    this.errorMessage = null;
                    this.showFieldsRequiredDialog = false;
                    this.timetracking = null;

                    this.shouldShowTimetracking = true;
                    this.shouldShowSubtasks = true;

                    if (this.$$('#loadSubtasks'))
                        this.$$('#loadSubtasks').active = true;

                    if (this.$$('#loadTransitions'))
                        this.$$('#loadTransitions').active = true;

                    if (this.$$('#loadTimetracking'))
                        this.$$('#loadTimetracking').active = true;

                },

                issueFechada: function (item) {
                    return STATUSES_COMPLETED_IDS.indexOf(item.status) != -1;
                },

                issueCancelada: function (item) {
                    return STATUSES_CANCELED_IDS.indexOf(item.status) != -1;
                },

                issueBlocked: function (item) {
                    return this.item.customfields.impedido;
                },

                getIssueTypeName: function(issueTypeId) {
                    return taskboard.getIssueTypeName(issueTypeId);
                },

                getIssueTypeImage: function(issue) {
                    return issue.typeIconUri.replace('xsmall', 'medium');
                },

                getStatusName: function(statusId) {
                    return taskboard.getStatusName(statusId);
                }

            });

        })();
    </script>

</dom-module>
