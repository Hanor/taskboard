<!doctype html>

<html>
<head>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>Widget CFD Test</title>

    <link rel="import" href="/static/bower_components/polymer/polymer.html" />
    <link rel="import" href="/static/bower_components/test-fixture/test-fixture.html" />

    <script src="/static/bower_components/webcomponentsjs/webcomponents.min.js"></script>
    <script src="/static/bower_components/web-component-tester/browser.js"></script>
    <script src="/static/bower_components/test-fixture/test-fixture-mocha.js"></script>
    <script src="/static/bower_components/iron-test-helpers/mock-interactions.js"></script>

    <!-- dependencies -->
    <script src="/static/bower_components/crossfilter2/crossfilter.js"></script>
    <script src="/static/bower_components/d3/d3.js"></script>
    <script src="/static/bower_components/dcjs/dc.js"></script>
    <link rel="stylesheet" href="/static/bower_components/dcjs/dc.css" />

    <!-- Import the element to test -->
    <link rel="import" href="/static/elements/taskboard/kpis/widget-cfd.html">

</head>
<body>

    <test-fixture id="widget-cfd-fixture">
        <template>
            <widget-cfd></widget-cfd>
        </template>
    </test-fixture>

    <script>
        suite('<widget-cfd>', function() {
            var widgetCfd;

            setup(function() {
                widgetCfd = fixture('widget-cfd-fixture');
            });

            test('component loads correctly', function() {
                assert.isDefined(widgetCfd.root, 'should be defined.');
            });

            suite('<load-project>', function() {
                var responseHeaders = {
                    json: { 'Content-Type': 'application/json' }
                };
                setup(function() {
                    server = sinon.fakeServer.create();
                    server.respondWith(
                        'GET',
                        '/api/project/MOCK/followup/cfd', [
                            200,
                            responseHeaders.json,
                            '{"lanes": ["Sub-Task"]'
                            + ', "types": ["Sub-Task", "Review", "Development", "QA", "UX"]'
                            + ', "labels": ["ToDo", "Doing", "Done"]'
                            + ', "dates": ["2000-01-01", "2000-01-02", "2000-01-03", "2000-01-04", "2000-01-05", "2000-01-06", "2000-01-07"]'
                            + ', "data": ['
                            + '  {"lane":0, "type": 0, "label": 0, "index": 0, "count": 0}'
                            + '  , {"lane":0, "type": 0, "label": 1, "index": 0, "count": 0}'
                            + '  , {"lane":0, "type": 0, "label": 2, "index": 0, "count": 0}'
                            + '  , {"lane":0, "type": 0, "label": 0, "index": 1, "count": 1}'
                            + '  , {"lane":0, "type": 0, "label": 1, "index": 1, "count": 0}'
                            + '  , {"lane":0, "type": 0, "label": 2, "index": 1, "count": 0}'
                            + '  , {"lane":0, "type": 0, "label": 0, "index": 2, "count": 3}'
                            + '  , {"lane":0, "type": 0, "label": 1, "index": 2, "count": 1}'
                            + '  , {"lane":0, "type": 0, "label": 2, "index": 2, "count": 0}'
                            + '  , {"lane":0, "type": 0, "label": 0, "index": 3, "count": 4}'
                            + '  , {"lane":0, "type": 0, "label": 1, "index": 3, "count": 3}'
                            + '  , {"lane":0, "type": 0, "label": 2, "index": 3, "count": 1}'
                            + '  , {"lane":0, "type": 0, "label": 0, "index": 4, "count": 6}'
                            + '  , {"lane":0, "type": 0, "label": 1, "index": 4, "count": 4}'
                            + '  , {"lane":0, "type": 0, "label": 2, "index": 4, "count": 3}'
                            + '  , {"lane":0, "type": 0, "label": 0, "index": 5, "count": 7}'
                            + '  , {"lane":0, "type": 0, "label": 1, "index": 5, "count": 6}'
                            + '  , {"lane":0, "type": 0, "label": 2, "index": 5, "count": 4}'
                            + '  , {"lane":0, "type": 0, "label": 0, "index": 6, "count": 9}'
                            + '  , {"lane":0, "type": 0, "label": 1, "index": 6, "count": 7}'
                            + '  , {"lane":0, "type": 0, "label": 2, "index": 6, "count": 6}'
                            + ']}'
                        ]
                    );
                    server.respondWith(
                        'GET',
                        '/api/project/STUB/followup/cfd', [
                            200,
                            responseHeaders.json,
                            '{"lanes": ["Sub-Task"]'
                            + ', "types": ["Sub-Task", "Review", "Development", "QA", "UX"]'
                            + ', "labels": ["ToDo", "Doing", "Done"]'
                            + ', "dates": ["2001-01-01", "2001-01-02", "2001-01-03", "2001-01-04", "2001-01-05", "2001-01-06", "2001-01-07"]'
                            + ', "data": ['
                            + '  {"lane":0, "type": 1, "label": 0, "index": 0, "count": 0}'
                            + '  , {"lane":0, "type": 1, "label": 1, "index": 0, "count": 0}'
                            + '  , {"lane":0, "type": 1, "label": 2, "index": 0, "count": 0}'
                            + '  , {"lane":0, "type": 1, "label": 0, "index": 1, "count": 2}'
                            + '  , {"lane":0, "type": 1, "label": 1, "index": 1, "count": 0}'
                            + '  , {"lane":0, "type": 1, "label": 2, "index": 1, "count": 0}'
                            + '  , {"lane":0, "type": 1, "label": 0, "index": 2, "count": 3}'
                            + '  , {"lane":0, "type": 1, "label": 1, "index": 2, "count": 2}'
                            + '  , {"lane":0, "type": 1, "label": 2, "index": 2, "count": 0}'
                            + '  , {"lane":0, "type": 1, "label": 0, "index": 3, "count": 5}'
                            + '  , {"lane":0, "type": 1, "label": 1, "index": 3, "count": 3}'
                            + '  , {"lane":0, "type": 1, "label": 2, "index": 3, "count": 2}'
                            + '  , {"lane":0, "type": 1, "label": 0, "index": 4, "count": 6}'
                            + '  , {"lane":0, "type": 1, "label": 1, "index": 4, "count": 5}'
                            + '  , {"lane":0, "type": 1, "label": 2, "index": 4, "count": 3}'
                            + '  , {"lane":0, "type": 1, "label": 0, "index": 5, "count": 8}'
                            + '  , {"lane":0, "type": 1, "label": 1, "index": 5, "count": 6}'
                            + '  , {"lane":0, "type": 1, "label": 2, "index": 5, "count": 5}'
                            + '  , {"lane":0, "type": 1, "label": 0, "index": 6, "count": 9}'
                            + '  , {"lane":0, "type": 1, "label": 1, "index": 6, "count": 8}'
                            + '  , {"lane":0, "type": 1, "label": 2, "index": 6, "count": 6}'
                            + ']}'
                        ]
                    );
                });

                teardown(function() {
                    server.restore();
                });

                test('load mock project', function() {
                    widgetCfd.selectedProjectKey = 'MOCK';
                    server.respond();
                    var svg = widgetCfd.$$('#cfd > svg');
                    assert.isDefined(svg, 'svg tag created');
                    expect(widgetCfd.isReady).to.be.true;
                });

                test('load mock project and change to stub project', function() {
                    widgetCfd.selectedProjectKey = 'MOCK';
                    server.respond();
                    var xAxisTickSvg = widgetCfd.$$('#cfd svg g.x.axis .tick text');
                    expect(xAxisTickSvg.textContent).to.equal('2000-01-01');

                    widgetCfd.selectedProjectKey = 'STUB';
                    server.respond();
                    xAxisTickSvg = widgetCfd.$$('#cfd svg g.x.axis .tick text');
                    expect(xAxisTickSvg.textContent).to.equal('2001-01-01');
                });

                test.skip('stress test', function() {
                    this.timeout(100000);
                    var timeTaken = [];
                    for(var i = 0; i < 20; ++i) {
                        var time = Date.now();

                        widgetCfd.selectedProjectKey = 'MOCK';
                        server.respond();
                        var xAxisTickSvg = widgetCfd.$$('#cfd svg g.x.axis .tick text');
                        expect(xAxisTickSvg.textContent).to.equal('2000-01-01');

                        widgetCfd.selectedProjectKey = 'STUB';
                        server.respond();
                        xAxisTickSvg = widgetCfd.$$('#cfd svg g.x.axis .tick text');
                        expect(xAxisTickSvg.textContent).to.equal('2001-01-01');

                        timeTaken[i] = Date.now()-time;
                    }

                    var min = d3.min(timeTaken);
                    var max = d3.max(timeTaken);
                    var mean = d3.mean(timeTaken);
                    var it = timeTaken.length;
                    console.log('min: ' + min + ' max: ' + max + ' mean: ' + mean + ' iterations: ' + it);
                });
            })
        });
    </script>

</body>
</html>